var token="";$(function(){if(""===token){var e=Cookie.get();""===e?(console.log("User needs to login!"),$("#login-form").modal({backdrop:"static",keyboard:!1})):(token=e,App.start(token))}else App.start(token)});var App={start:function(){App.init(),Global.periodicals()},init:function(){Global.registerHandlebarHelpers(),Template.showPlaces(),Template.init()&&$.each(Map.positions,function(e,t){var n=$(t.id+"-template"),i=$(t.id);n.length&&t.autoLoad===!0&&Data.get(t.template,null,n,i,null)})},close:function(){Cookie.delete(),Location.refresh()}},Template={init:function(){var e=!1;return $("#templates").children().length?(console.log("template exists!"),e=!0):$.ajax({url:Map.templates,async:!1,success:function(t){$("#templates").append(t),e=!0}}),e},showPlaces:function(){$.each(Map.places,function(e,t){$(t).length&&$(t).removeClass("hide")})},compile:function(e,t,n,i){var o=t.html(),t=Handlebars.compile(o),r=t(e);n.html(r),Template.afterCompile(r,i)},afterCompile:function(e,t){Map.positions[t].eventListener===!0&&Bindings[Map.positions[t].template].init(),-1!==e.indexOf('"nano')&&$(".nano").nanoScroller({flash:!0,preventPageScrolling:!0,tabIndex:0})}},Data={get:function(e,t,n,i){if("undefined"!=typeof e&&""!==e&&e){var o=Map.positions[e].service;null!==t&&(o+="/"+t),$.ajax({url:Map.serviceBase+o,headers:{Authorization:token},success:function(t){var o=JSON.parse(t);Template.compile(o,n,i,e)}})}else t=[],Template.compile(t,n,i,e)},post:function(e,t){if("undefined"!=typeof e&&""!==e&&e){{Map.positions[e].service}null!==t&&$.ajax({url:Map.serviceBase+Map.positions[e].service,headers:{Authorization:token},type:"post",data:t,success:function(e){console.log(e)}})}},put:function(){return!1}},Location={goBack:function(){Location.redirect(!0)},redirect:function(e){return"undefined"==typeof e?!1:(window.location.href=e,!0)},refresh:function(){location.reload()}},Global={isInt:function(e){return"number"==typeof parseInt(e)&&isFinite(parseInt(e))&&parseInt(e)%1===0},getVal:function(e,t,n){if(e.length){var i=e.attr(t);return"undefined"==typeof i&&(i=n),i}return!1},ucfirst:function(e){return"undefined"!=typeof e?e.charAt(0).toUpperCase()+e.slice(1):e},cleanText:function(e){return e.replace(/[^a-zA-Z\u0600-\u06FF\s]/gi,"")},registerHandlebarHelpers:function(){Handlebars.registerHelper("times",function(e,t){for(var n="",i=0;e>i;++i)n+=t.fn(i);return n}),Handlebars.registerHelper("date",function(e){var t="";("undefined"==typeof e||""===e)&&(e=0);var n=new Date;n.setDate(n.getDate()+e);var i=n.getDate(),o=n.getMonth()+1,r=n.getFullYear();return 10>i&&(i="0"+i),10>o&&(o="0"+o),t=o+"/"+i+"/"+r}),Handlebars.registerHelper("date2",function(e){var t="";("undefined"==typeof e||""===e)&&(e=0);var n=new Date;n.setDate(n.getDate()+e);var i=n.getDate(),o=n.getMonth()+1,r=n.getFullYear();return 10>i&&(i="0"+i),10>o&&(o="0"+o),t=r+"-"+o+"-"+i}),Handlebars.registerHelper("htimes",function(e,t){for(var n="",i=1;e+1>i;++i)n+=t.fn(i);return n}),Handlebars.registerHelper("for",function(e,t,n,i){for(var o="",r=e;t>r;r+=n)o+=i.fn(r);return o}),Handlebars.registerHelper("ifCond",function(e,t,n){return e===t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("ifActive",function(e){var t="undefined"==typeof Location.parts[2]?0:Location.parts[2];return parseInt(e)===parseInt(t)?"grey-cascade":"btn-default"}),Handlebars.registerHelper("cycle",function(e,t){var n=e.split(" ");return n[t.data.index%(n.length+1)]}),window.Handlebars.registerHelper("select",function(e,t){var n=$("<select />").html(t.fn(this));return n.find("[value="+e+"]").attr({selected:"selected"}),n.html()})},periodicals:function(){window.setInterval(function(){Cookie.extend(Cookie.title,token)},1e4)}},Map={templates:"data/templates.html",serviceBase:"http://192.168.101.154:91/Assignment.svc/",places:[".wrapper"],services:{},login:{service:"login"},positions:{userparams:{id:"#userparams",template:"userparams",service:"UserParams",autoLoad:!0,eventListener:!1},results:{id:"#results",template:"results",service:"AssignmentItemGetAll",autoLoad:!0,eventListener:!0},conversation:{id:"#conversation",template:"conversation",service:"AssignmentItemDetGetAll",autoLoad:!1,eventListener:!0},assignment:{id:"",template:"",service:"AssignmentItemDetCreate",autoLoad:!1,eventListener:!1}}},Bindings={results:{init:function(){Bindings.results.click()},click:function(){$(document).on("click","#results .content li",function(e){var t=$(this).attr("data-id");Data.get("conversation",t,$("#conversation-template"),$("#conversation"),"",$(this).text()),e.preventDefault()})}},conversation:{init:function(){Bindings.conversation.scrollBottom(),Bindings.conversation.add()},add:function(){$(document).on("click","#conversation .item-form a.do-send",function(e){var t=$(this).parent().find("textarea").val(),n=$(this).parent().find("input[type=hidden]").val();Data.post("assignment",{Title:t,AssignmentItemId:n},null,null,null),e.preventDefault()})},scrollBottom:function(){$("#conversation .nano").nanoScroller({scroll:"bottom"})}},userParams:{init:function(){Bindings.results.fillParams()},fillParams:function(){}}},Cookie={lifetime:600,title:"newsroom=",init:function(){},check:function(e){if("undefined"==typeof e)var e=Cookie.title;return Cookie.get(Cookie.title)},parse:function(e){return"undefined"!=typeof e?e:!1},"delete":function(e){if("undefined"==typeof e)var e=Cookie.title;var t="Thu, 01 Jan 1970 00:00:01 GMT";document.cookie=e+"; "+t+"; path=/"},extend:function(e,t){console.log("extending user session"),Cookie.set(e,t)},set:function(e,t){if("undefined"==typeof e)var e=Cookie.title;var e=Cookie.title,n=new Date;n.setTime(n.getTime()+1e3*Cookie.lifetime);var i="expires="+n.toGMTString();return document.cookie=e+t+"; "+i+"; path=/",t},get:function(e){if("undefined"==typeof e)var e=Cookie.title;for(var t=document.cookie.split(";"),n=0;n<t.length;n++){var i=t[n].trim();if(0===i.indexOf(e))return Cookie.parse(i.substring(e.length,i.length))}return""}};$(document).on("click","#login-anchor",function(e){var t=!1;return $.ajax({url:Map.serviceBase+Map.login.service,data:$("#login-form form:first").serialize(),type:"post",success:function(e){""!==e?(token=e,$("#login-form").find(".alert").addClass("hide"),$("#login-form").modal("hide"),Cookie.set(Cookie.title,e),App.start(t)):$("#login-form").find(".alert").slideDown(function(){$("#login-form").find(".alert").removeClass("hide")})}}),e.preventDefault(),!1}).on("click",".logout",function(){App.close()}).on("focusin","#login-form form:first",function(){$("#login-form").find(".alert").slideUp(function(){$("#login-form").find(".alert").addClass("hide")})});
